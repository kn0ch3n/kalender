// Auto-generated from kalender.html.
// DO NOT EDIT.

library kalender_html;

import 'dart:html' as autogenerated;
import 'dart:svg' as autogenerated_svg;
import 'package:web_ui/web_ui.dart' as autogenerated;
import 'package:web_ui/observe/observable.dart' as __observe;
import 'dart:html';
import 'package:web_ui/web_ui.dart';
import 'x_appointment.dart';
import 'x_pause.dart';
import 'dart:json' as JSON;
import 'dart:async';
import 'kalender_connection.dart';
import 'dart:math';


// Original code


KalenderConnection kalenderConnection;
DivElement termineDiv;
List<DivElement> appointmentColumns = new List<DivElement>();
String selectedDate;
String lastSelectedDate;
final List<String> monthNames = ["Jänner", "Februar", "März", 
                                 "April", "Mai", "Juni", 
                                 "Juli", "August", "September", 
                                 "Oktober", "November", "Dezember"];
final List<String> weekdaysShort = ["Mo", "Di", "Mi", "Do", "Fr", "Sa", "So"];
int daysInMonth;
String monthName;
String yearAndMonth;
int maxDays = 31;

List<XAppointment> xappointments = new List<XAppointment>();
List<XPause> xpauses = new List<XPause>();

void main() {
  //useShadowDom = true;
  ParagraphElement statusElem = query('#status-area');
  statusArea = new StatusArea(statusElem);
  
  kalenderConnection = new KalenderConnection("ws://127.0.0.1:1337/ws");
  XAppointment.connection = kalenderConnection;
  XPause.connection = kalenderConnection;
  
  selectedDate = toDateString(new DateTime.now());
  setupUI();
  
  document.body.onMouseWheel.listen((WheelEvent e) {
    e.preventDefault();
    document.body.scrollLeft += e.deltaY;
  });
}

String toDateString(DateTime dateTime) {
  var day = dateTime.day > 9 ? dateTime.day : "0" + dateTime.day.toString();
  var month = dateTime.month > 9 ? dateTime.month : "0" + dateTime.month.toString();
  var year = dateTime.year;
  
  return "$year-$month-$day";
}

void setupUI() {
  termineDiv = query("#termine");
  
  for (int i = 1; i <= maxDays; i++) {
    var id = i.toString().length > 1 ? i.toString() : "0" + i.toString();
    var column = query("#termine_$id");
    appointmentColumns.add(column);
    if (column != null) {
      for (int h = 8; h <= 17; h++) {
        for (int m = 0; m <= 40; m += 20) {
          DateTime t = new DateTime(
              int.parse(selectedDate.substring(0, 4)),
              int.parse(selectedDate.substring(5, 7)),
              i, h, m);
          if (h == 12 && m == 0) xpauses.add(pauseCreator(t, column));
          if (h == 12 || h == 13) continue;
          String id = i > 9 ? i.toString() : "0" + i.toString();
          int x = ((h-8)*3 + (m/20) + 1).toInt();
          id += x > 9 ? x.toString() : "0" + x.toString();
          xappointments.add(appointmentCreator(t, id, column));
        }
      }
    }
  }
  
  dateChanged(); // Resize width of the termine div
}

XAppointment appointmentCreator(DateTime time, String id, var parent) {
  var obj = new XAppointment(time, id);
  var lifecycleCaller = new ComponentItem(obj)..create();
  parent.children.add(obj.host);
  lifecycleCaller.insert();
  return obj;
}

XPause pauseCreator(DateTime time, var parent) {
  var obj = new XPause(time);
  var lifecycleCaller = new ComponentItem(obj)..create();
  parent.children.add(obj.host);
  lifecycleCaller.insert();
  return obj;
}

void dateChanged() {
  //print("selected: $selectedDate , lastSelected: $lastSelectedDate");
  if (lastSelectedDate == null || selectedDate.substring(0, 7) != lastSelectedDate.substring(0, 7)) {
    print("dateChanged(): different month, updating view");
    
    daysInMonth = toDaysInMonth(selectedDate);
    monthName = toMonthName(selectedDate);
    yearAndMonth = selectedDate.substring(0, 7);

    clearAllXAppointments();

    var year = selectedDate.substring(0, 4);
    for (int i = 1; i <= maxDays; i++) {
      var id = i.toString().length > 1 ? i.toString() : "0" + i.toString();

      // Create the heading for the day
      var headingElement = query("#termine_$id h3");
      if(headingElement != null) {
        DateTime d = DateTime.parse(selectedDate.substring(0, 8) + id);
        if(d.add(new Duration(days: 1)).isAfter(new DateTime.now())) {
          headingElement.classes.add("after");
          headingElement.classes.remove("before");
        } else {
          headingElement.classes.add("before");
          headingElement.classes.remove("after");
        }
        headingElement.innerHtml = "${weekdaysShort[d.weekday - 1]}, $i. $monthName $year";
      }

      // Hide days not in current month
      if(i >= 28) {
        var termineElement = query("#termine_$id");
        if(termineElement != null) {
          if(i > daysInMonth) {
            termineElement.style.display = "none";
          } else {
            termineElement.style.display = "inline-block";
          }
        }
      }
    }

    // Change the times of the XAppointment instances
    for (XAppointment x in xappointments) {
      x.time = DateTime.parse(selectedDate.substring(0, 7) + x.time.toString().substring(7));
    }

    // Change the times of the XPause instances
    for (XPause x in xpauses) {
      x.time = DateTime.parse(selectedDate.substring(0, 7) + x.time.toString().substring(7));
    }

    // resize #termine
    query("#termine").style.width = "${daysInMonth * 250}px}";
    // request this months appointments
    kalenderConnection.sendRequest(yearAndMonth);
  } else {
    print("dateChanged(): same month, not updating view");
  }

  //scroll to the right day
  document.body.scrollLeft = (int.parse(selectedDate.substring(8, 10)) - 1) * 250;
  
  lastSelectedDate = selectedDate;
}

void clearAllXAppointments() {
  for(var x in XAppointment.dirtyAppointments) {
    x.clear();
  }
  XAppointment.dirtyAppointments.clear();
}

String toMonthName(String dateString) {
  int monthNumber = int.parse(dateString.substring(5, 7));
  return monthNames[monthNumber - 1];
}

int toDaysInMonth(String dateString) {
  String m = dateString.substring(5, 7);
  if(m == "02") {
    int y = int.parse(dateString.substring(0, 4));
    if(y % 4 == 0) {
      if(y % 100 == 0) {
        if(y % 400 == 0){
          return 29;
        }
        return 28;
      }
      return 29;
    }
    return 28;
  } else if(m == "04" || m == "06" || m == "09" || m == "11") {
    return 30;
  } else return 31;
}

// Additional generated code
void init_autogenerated() {
  var __root = autogenerated.document.body;
  var __e0;
  var __t = new autogenerated.Template(__root);
  __e0 = __root.nodes[1].nodes[3];
  __t.listen(__e0.onChange, ($event) { dateChanged(); });
  __t.listen(__e0.onInput, ($event) { selectedDate = __e0.value; });
  __t.oneWayBind(() => selectedDate, (e) { if (__e0.value != e) __e0.value = e; }, false, false);
  __t.create();
  __t.insert();
}

//# sourceMappingURL=kalender.dart.map